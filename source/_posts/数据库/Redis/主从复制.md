---
title: 主从复制
date: 2020-11-19 16:54:53
tags: redis
categories: redis
---
## 作用

1. 数据副本
2. 扩展读性能

## 实现方式

### slaveof命令

```
slaveof 复制（异步）
slaveof no one 取消复制（不会清除历史数据，只是不再同步新的数据）
```

### 配置

```
slaveof ip port
slave-read-only yes
```

### 比较

|方式|命令|配置|
|--|--|--|
|优点|无需重启|统一配置|
|缺点|不便于管理|需要重启|

## 全量复制

{% asset_img 全量复制.png 全量复制%}

### 全量复制开销

1. bgsave时间
2. RDB文件网络传输时间
3. 从节点清空数据时间
4. 从节点加载RDB的时间
5. 可能的AOF重写时间

## 部分复制

{% asset_img 部分复制.png 部分复制%}

## 故障转移

1. 故障发现
2. 故障恢复
    - 资格检查
    - 准备选举时间
    - 发起选举
    - 选举投票
    - 替换主节点

## 开发与运维中的问题

### 读写分离

1. 读写分离：读流量分摊到从节点。
2. 可能遇到问题：
    - 复制数据延迟
    - 读到过期数据
    - 从节点故障

### 主从配置不一致

1. 例如maxmemory不一致：丢失数据
2. 例如数据结构优化参数（例如hash-max-ziplist-entries）:内存不一致

### 规避全量复制

1. 第一次全量复制
    - 第一次不可避免
    - 小主节点、低峰
2. 节点运行ID不匹配
    - 主节点重起（运行ID变化）
    - 故障转移，例如哨兵或集群
3. 复制积压缓冲区不足
    - 网络中断，部分复制无法满足
    - 增大复制缓冲区配置rel_backlog_size,网络“增强”

### 规避复制风暴

1. 单主节点复制风暴：
    - 问题：主节点重起，多从节点复制
    - 解决:更换复制拓扑
2. 单机器复制风暴
    - 当多个maseter在一台主机上，机器宕机后，大量全量复制
    - 主节点分散多机器
