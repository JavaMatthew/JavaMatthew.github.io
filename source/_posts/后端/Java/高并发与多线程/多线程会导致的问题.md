---
title: 多线程会导致的问题
p: 后端/Java/高并发与多线程/多线程会导致的问题
date: 2020-03-05 16:14:53
tags: [Java,多线程]
categories: [Java,多线程]
---
## 线程安全问题

什么是线程安全？

《Java Concurrency In Practice》的左子Brian Gortz对“线程安全”有一共比较恰当的定义：“当多个线程访问一个对象是，如果不用考虑这些线程在运行时环境下的调度和交替执行，也不需要进行额外的同步，或者在调用方进行任何其他的协调操作，调用这个对象的行为都可以获得正确的结果，那这个对象是线程安全的。

自己的理解：不管业务中遇到怎样的多个线程访问某对象或某方法的情况，而在编程这个业务逻辑的时候，都不需要额外做任何额外的处理（也就是可以想单线程编程一样）程序也可以正常运行（不会因为多线程而出错），就可以称为线程安全。

- 线程不安全：get同时set、额外同步
- 全都线程安全？：运行速度、设计成本、trade off
- 完全不用于多线程：不过度设计

### 什么情况下会出现线程安全问题，怎么避免

- 运行结果错误：a++多线程下出现消失的请求现象
- 活跃性问题：死锁、活锁、饥饿
- 对象发布和初始化的时候的安全问题

#### 什么是逸出

1. 方法返回一个private对象（private的本意是不让外部访问）
2. 还未完成初始化（构造函数没完全执行完毕）就把对象提供给外界，比如：
在构造函数中未初始化完毕就this赋值
隐式逸出————注册监听事件
构造函数中运行线程

#### 如何解决逸出

1. 返回副本
2. 利用工厂模式

#### 各种需要考虑线程安全的情况

- 访问**共享**的变量或资源，会有并发风险，比如对象的属性、静态变量、共享缓存、数据库等。
- 所有依赖**时序**的操作，即使每一步操作都是线程安全的，还是存在并发问题：read-modify-write、check-then-act。
- 不同的数据之间存在**捆绑**关系的时候。IP和端口号
- 我们使用其他类的时候，如果对方没有声明自己是线程安全的，那么大概率会存在并发问题。

## 性能问题

### 为什么多线程会带来性能问题

- 调度：上下文切换
  - 什么是上下文？保存现场
    上下文切换可以认为是内核（操作系统的核心）在CPU上对于进程（包括线程）进行以下的活动：
    （1）挂起一个进程，将这个进程在CPU中的状态（上下文）存储与内存中的某处，
    （2）在内存中检索下一个进程的上下文并将其在CPU的寄存器中恢复，
    （3）跳转到程序计数器所指向的位置（即跳转到进程被中断时的代码行），以恢复该进程。
  - 缓存开销：缓存失效，CPU重新缓存
  - 何时会导致密集的上下文切换：抢锁、IO
- 协作：内存同步
    Java内存模型，为了数据的正确性，同步手段往往会使用进制编译器优化、使CPU内的缓存失效

### 性能问题有哪些体现、什么是性能问题

服务器响应慢、吞吐量低、资源消耗（例如内存）过高等
虽然不是结果错误，但依然危害巨大
引入多线程不能本末倒置
