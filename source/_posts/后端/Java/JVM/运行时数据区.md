---
title: 运行时数据区
p: 后端/Java/JVM/运行时数据区
date: 2020-04-25 17:01:17
tags: [Java,JVM]
categories: [Java,JVM]
---
## 运行时数据区

{% asset_img 运行时数据区.png 运行时数据区%}

Java虚拟机定义了若干种程序运行期间会使用到的运行时数据区,其中由一些会随着虚拟机启动而创建,随着虚拟机退出而销毁.另外一些则是与线程一一对应的,这些与线程对应的数据区域会随着线程开始和结束而创建和销毁.
灰色的为单独线程私有的,红色的为多个线程共享的.即:
> 每个线程:独立包括程序计数器、栈、本地栈
> 线程间共享：堆、堆外内存（永久代或元空间、代码缓存）

## 线程

- 线程是一个程序里的运行单元。JVM允许一个应用有多个线程并行的执行。
- 在Hotspot JVM里，每个线程都与操作系统的本地线程直接映射。
  - 当一个Java线程准备好执行以后，此时一个操作系统的本地线程也同事创建。Java线程执行终止后，本地线程也会回收。
- 操作系统负责所有线程的安排调度到任何一个可用的CPU上。一旦本地线程初始化成功，它就会调用Java线程中的run()方法

- 如果你是用jconsole或者是任何一个调试工具，都能看到在后台有许多线程在运行。这些后台线程不包括调用public static void main(String[])的main线程以及所有这个main线程自己创建的线程。

- 这些主要的后台系统线程在Hotspot JVM里主要是以下几个：
  - **虚拟机线程：**这种线程的操作是需要JVM达到安全点才会出现。这些操作必须在不同的线程中发生的原因是他们都需要JVM达到安全点，这样堆才不会变化。这种线程的执行类型包括"stop-the-world"的垃圾手机，线程栈手机，线程挂起以及偏向所撤销。
  - **周期任务线程：**这种线程是时间周期事件的体现（比如中断），他们一般用于周期性操作的调度执行。
  - **GC线程：**这种线程对在JVM里不同种类的垃圾手机行为提供了支持。
  - **编译线程：**这种线程在运行时会将字节码编译成到本地代码
  - **信号调度线程：**这种线程接收信号兵发送给JCM，在它内部通过调用适当的方法进行处理。

## 程序计数器（PC寄存器）

JVM中的程序计数寄存器中，Register的命名源于CPU的寄存器，寄存器存储指令相关的线程信息。CPU只有把数据庄仔倒寄存器才能够运行。
这里，并非是广义上所指的物理寄存器，获取将其翻译为PC计数器（或指令计数器）会更加贴切（也成为了程序钩子），并且也不容易引起一些不必要的误会。JVM中PC寄存器是对物理PC寄存器的一种抽象模拟。

### 作用

PC寄存器用来存储指向下一条指令的地址，也即将要执行的指令代码。有执行引擎读取下一条指令。

它是唯一一个在Java虚拟机规范中没有规定任何OutOfMemoryError情况的区域

### 常见问题

1. 使用PC寄存器存储字节码指令地址有什么用呢？
    为什么使用PC寄存器记录当前线程的执行地址呢？

    因为CPU需要不停地切换各个线程，这时候切换回来以后，就得知道接着从哪开始继续执行。
    JVM的字节码解释器就需要通过改变PC寄存器的值来明确下一条应该执行什么样的字节码指令

2. PC寄存器为什么会被设定为线程私有？

    我们都知道所谓的多线程在一个特定的时间段内只会执行其中某一个线程的方法，CPU会不停地做任务切换，这样必然导致进场中断或回复，如何保证分好无差呢？**为了能够准确地记录哥哥线程正在执行的当前字节码指令地址，最好的办法自然是为每一个线程都分配一个PC寄存器**，这样一来哥哥线程之间便可以进行独立计算，从而不会出现相互干扰的情况。
    由于CPU时间片轮限制，众多线程在并发执行过程中，任何一个确定的时刻，一个处理器或者多核处理器中的一个 内核，只会执行某个线程中的一条指令。
    这样必然导致经常中断或回复，如何保证分毫不差呢？每个线程在创建后，都会产生自己的程序计数器和栈帧，程序计数器在哥哥线程之间互不影响

## CPU时间片

CPU时间片即CPU分配给各个程序的时间，每个线程被分配一个时间段，称作它的时间片。
在宏观上:我们可以同时打开多个应用程序，每个程序并行，同时运行
但在微观上:由于只有一个CPPU，一次只能处理程序要求的一部分，如何处理公平，一种方法就是引入时间片，每个程序轮流执行

## 虚拟机栈

### 内存中的栈于堆

栈式运行时的单位，而堆时存储的单位。

即：栈解决程序的运行问题，何须如何执行，或者说如何处理数据。
堆解决的时数据存储的问题，即数据怎么放、放在哪儿。

### 虚拟机栈基本内容

- Java虚拟机栈式什么？
  Java虚拟机栈，早起也叫Java栈。没干过线程在创建时都会创建一个虚拟机栈，其内部保存一个个的栈帧，对应着一次次的Java方法调用。
  - 是线程私有的
- 生命周期和线程一直
- 作用：主管Java程序的运行，它保存方法的局部变量、部分结果，并参与方法的调用和返回。

### 栈的优点

- 栈式一种快速有效的分配存储方式，访问速度仅次于程序计数器。
- JVM直接对Java栈的操作只有两个：
  - 每个方法执行，伴随着进栈
  - 执行结束后的出栈工作
- 对于栈来说不存在垃圾回收问题

### 栈中可能出现的异常

- Java虚拟机规范允许Java栈的大小是动态的或者是固定不变的。
  - 如果采用固定大小的Java虚拟机栈，那每一个线程的Java虚拟机栈容量可以在线程创建的时候独立选定。如果线程请求分配栈容量超过Java虚拟机栈允许的最大容量，Java虚拟机将会跑出一个StackOverflowError异常。
  - 如果Java虚拟机栈可以动态扩展，并且在尝试扩展的时候无法申请到足够的内存，或者在创建新的线程时没有足够的内存去创建对应的虚拟机栈，那Java虚拟机将会派出一个OutOfMemoryError异常

### 设置栈内存大小

我们可以使用参数-Xss选项来设置线程的最大栈空间，栈的大小直接决定了函数调用的最大可达深度
